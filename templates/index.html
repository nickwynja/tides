<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1, maximum-scale=1, interactive-widget=overlays-content" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒŠ</text></svg>">

<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">

{% include 'splash.html' %}
{% include 'plotly.html' %}
{% include 'turbo.html' %}

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker
                .register('/service-worker.js')
                .then((registration) => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch((error) => {
                    console.error('Service Worker registration failed:', error);
                });
        });
    }

document.addEventListener("turbo:load", () => {
    var favCheck = document.getElementById('fav');
    var favState = document.getElementById('fav_state');

    document.getElementById('tide').onchange = (event) => {
        favCheck.checked = false;
        favState.checked = false;
    }

    document.getElementById('current').onchange = (event) => {
        favCheck.checked = false;
        favState.checked = false;
    }

    var myPlot = document.getElementById('myPlot')
    myPlot.on('plotly_relayout', function(){
        var range = myPlot.layout.xaxis.range;
        var start = new Date(range[0]).getTime() / 1000;
        var end = new Date(range[1]).getTime() / 1000;

        var annotations = [];

        if ((end - start) > 64800) {
            myPlot.layout.annotations.forEach(item => {
                if (item.name == "wind") {
                    item.visible = false;
                    annotations.push(item);
                }
            });
            Plotly.update(myPlot, {annotations: annotations});
        } else {
            myPlot.layout.annotations.forEach(item => {
                if (item.name == "wind") {
                    item.visible = true;
                    annotations.push(item);
                }
            });
            Plotly.update(myPlot, {annotations: annotations});
        };
	});


})


</script>


<style>

html {
    overscroll-behavior: none;
}

body {
    font-family: monospace;
    font-size: 16px;
    color: white;
    background-color: rgb(17, 17, 17);
}

td {
    padding: 0 5px 5px 5px;
}


select,
select:focus,
button,
input {
    font-size: 18px;
    font-family: monospace;
    background-color: black;
    border-color: white;
    border-radius: 2px;
    border-style: solid;
    color: white;
    font-weight: normal;
    height: 28px;
    /* the following ensures they're all using the same box-model for rendering */
    -moz-box-sizing: border-box; /* or `border-box` */
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    vertical-align: middle;
}

button {
    background-color: #4ea6d9;
    border-color: #4ea6d9;
    color: black;
}

a {
    color: #4ea6d9;
}

img {
    max-width: 100%;
}

.flex {
    display: flex;
    flex-wrap: wrap;
}

form.flex {
    margin: 5px 0;
}

form .row {
    margin-bottom: 5px;
}


@media (min-width: 800px) {
    form .row {
        margin: 0 20px 5px 0;
    }
    .details .row {
        width: 50%

    }
}


select {
    max-width: 350px;
}

#offset {
    width: 70px;
}

.offset-num {
    margin-right: 10px;

}

#map {
    max-width: 100%;
}

.favs {
    margin: 10px 0 10px 0;
}

</style>

<title>Tides</title>
</head>

<body>

{{ fig_html | safe }}


<div class="favs">
{% for f in favs %}

{% set tf = f.split(":")[0] %}
{% set cf = f.split(":")[1] %}


<a href={{ url_for('tides', current=cf, tide=tf) }}>{{ tf }}:{{ cf }}</a>

{% endfor %}
</div>

<form action="/" method="POST" class="flex">
    <div class="row">
        <label for="tide">Tide:</label>
        <select name="tide" id="tide">
            {% for s in local_tide_stations | sort(attribute='name') %}
            <option value="{{s.id}}" {{'selected' if tide_station['id'] == s['id']}} >{{ s.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="row">
      <label for="current">Current:</label>
      <select name="current" id="current">
          {% for s in local_current_stations | selectattr("currbin", "equalto", 1) | sort(attribute='name') %}
          <option value="{{s.id}}" {{'selected' if current_station['id'] == s['id']}} >{{ s.name }}</option>
          {% endfor %}
      </select>
    </div>
    <!-- <div class="row"> -->
    <!--   <label for="met">Met:</label> -->
    <!--   <select name="met" id="met" hidden> -->
    <!--       {% for s in local_met_stations | sort(attribute='name') %} -->
    <!--       <option value="{{s.id}}" {{'selected' if met_station['id'] == s['id']}} >{{ s.name }}</option> -->
    <!--       {% endfor %} -->
    <!--   </select> -->
    <!-- </div> -->
    <div class="row">
      <input type="number" placeholder="+/-" name="offset" id="offset"/>
      {% if tide_offset != 0 %}
      <span class="offset-num">{{ "+" if tide_offset > 0 else ""}}{{ tide_offset }}m</span>
      {% endif %}
        <label for="fav">Fav</label>
        <input type="checkbox" id="fav" name="fav" {{ 'checked' if is_fav else '' }} />
        <input hidden type="checkbox" id="fav_state" name="fav_state" {{ 'checked' if is_fav else '' }} />
        <button type="submit"/>Submit</button>
    </div>
</form>

<div class="flex details">
    <div class="row">
        <details>
            <summary>Today's text report</summary>
            <br>
            <table>
                {% for t in text_report %}
                <tr>
                    <td>{{ t.time.strftime('%H:%M')}}</td>
                    <td>{{ t.text|safe}}</td>
                </tr>
                {% endfor %}
            </table>
        </details>

        <h3>WX</h3>
        <p><a href="https://marine.weather.gov/MapClick.php?lat={{ current_station['lat'] }}&lon={{ current_station['lng'] }}">Marine Forecast</a></p>
        <table>
            {% for f in forecast %}
            <tr>
                <td>{{ f.when}}</td>
                <td>{{ f.text}}</td>
            </tr>
            {% endfor %}
        </table>

        <h3>Observations</h3>

        <table>
            <thead>
                <tr>
                    <th></th>
                    {% for station in met_data['Wind Speed'].keys() %}
                    <th><a href="https://www.ndbc.noaa.gov/station_page.php?station={{station}}">{{ station }}</a></th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for data_type, values in met_data.items() %}
                <tr>
                    <td>{{ data_type }}</td>
                    {% for station, value in values.items() %}
                    <td>{{ value|safe }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Station Details</h3>
        {% set tc = tide_station['lng']|string + "," + tide_station['lat']|string %}
        {% set cc = current_station['lng']|string + "," + current_station['lat']|string %}
        {% set at = "pk.eyJ1Ijoibmlja3d5bmphIiwiYSI6ImNtMzh6ZWN0YzBrbXUybG9nYXhjdnFlc2cifQ.uUURdxJOZ72zXmM9oqvW7g" %}

        <table>
            <tr>
                <td style="color: blue;">Tide:</td>
                <td><a href="https://tidesandcurrents.noaa.gov/stationhome.html?id={{ tide_station['id'] }}"</a>{{ tide_station['name'] }}</td>
            </tr>
            <tr>
                <td></td>
                <td><a href="https://tidesandcurrents.noaa.gov/map/index.html?lat={{ tide_station['lat'] }}&lng={{ tide_station['lng'] }}&zoom=11&type=tidepredictions&id={{ tide_station['id'] }}">View on map</td>
            </tr>
            <tr>
                <td></td>
                <td>{{ tide_station['lat'] }}, {{ tide_station['lng'] }}</td>
            </tr>
            <tr>
                <td style="color: red;">Current:</td>
                <td><a href="https://tidesandcurrents.noaa.gov/noaacurrents/predictions.html?id={{ current_station['id'] }}_1"</a>{{ current_station['name'] }}</td>
            </tr>
            <tr>
                <td></td>
                <td>{{ current_station['lat'] }}, {{ current_station['lng'] }}</td>
            </tr>
            <tr>
                <td></td>
                <td><a href="https://tidesandcurrents.noaa.gov/map/index.html?lat={{ current_station['lat'] }}&lng={{ current_station['lng'] }}&zoom=11&type=currentpredictions&id={{ current_station['id'] }}">View on map</td>
            </tr>
        </table>
    </div>
    <div class="row">
        <img id="map" src="https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/static/pin-s+1e00ff({{tc}}),pin-s+ff0000({{cc}})/auto/800x500?padding=50&access_token={{at}}" />
    </div>
</div>

</body>
</html>
