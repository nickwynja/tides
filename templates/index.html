<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1, maximum-scale=1, interactive-widget=overlays-content" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒŠ</text></svg>">

<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">

{% include 'splash.html' %}
{% include 'plotly.html' %}
{% include 'turbo.html' %}

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker
                .register('/service-worker.js')
                .then((registration) => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch((error) => {
                    console.error('Service Worker registration failed:', error);
                });
        });
    }

document.addEventListener("turbo:load", () => {
    var favCheck = document.getElementById('fav');
    var favState = document.getElementById('fav_state');

    document.getElementById('tide').onchange = (event) => {
        favCheck.checked = false;
        favState.checked = false;
    }

    document.getElementById('current').onchange = (event) => {
        favCheck.checked = false;
        favState.checked = false;
    }
})


</script>


<style>

html {
    overscroll-behavior: none;
}

body {
    font-family: monospace;
    font-size: 16px;
    color: white;
    background-color: black;
}

td {
    padding: 0 5px 5px 5px;
}


select,
select:focus,
button,
input {
    font-size: 18px;
    font-family: monospace;
    background-color: #888;
    border-color: #888;
    border-radius: 2px;
    border-style: solid;
    color: black;
    font-weight: normal;
    height: 28px;
    /* the following ensures they're all using the same box-model for rendering */
    -moz-box-sizing: border-box; /* or `border-box` */
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    vertical-align: middle;
}

a {
    color: cornflowerblue;
}

form.flex {
    display: flex;
    flex-wrap: wrap;
    margin: 5px 0;
}

form .row {
    margin-bottom: 5px;
}

@media (min-width: 800px) {
    form .row {
        margin: 0 20px 5px 0;
    }
}


select {
    max-width: 350px;
}

#offset {
    width: 4ch;
}

.offset-num {
    margin-right: 10px;

}

#map {
    max-width: 100%;
}

.favs {
    margin: 0 5px 15px 0;
}

</style>

<title>Tides</title>
</head>

<body>

{{ fig_html | safe }}


<div class="favs">
{% for f in favs %}

{% set tf = f.split(":")[0] %}
{% set cf = f.split(":")[1] %}


<a href={{ url_for('tides', current=cf, tide=tf) }}>{{ tf }}:{{ cf }}</a>

{% endfor %}
</div>

<form action="/" method="POST" class="flex">
    <div class="row">
        <label for="tide">Tide:</label>
        <select name="tide" id="tide">
            {% for s in local_tide_stations | sort(attribute='name') %}
            <option value="{{s.id}}" {{'selected' if tide_station['id'] == s['id']}} >{{ s.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="row">
      <label for="current">Current:</label>
      <select name="current" id="current">
          {% for s in local_current_stations | selectattr("currbin", "equalto", 1) | sort(attribute='name') %}
          <option value="{{s.id}}" {{'selected' if current_station['id'] == s['id']}} >{{ s.name }}</option>
          {% endfor %}
      </select>
    </div>
    <!-- <div class="row"> -->
    <!--   <label for="met">Met:</label> -->
    <!--   <select name="met" id="met" hidden> -->
    <!--       {% for s in local_met_stations | sort(attribute='name') %} -->
    <!--       <option value="{{s.id}}" {{'selected' if met_station['id'] == s['id']}} >{{ s.name }}</option> -->
    <!--       {% endfor %} -->
    <!--   </select> -->
    <!-- </div> -->
    <div class="row">
      <label for="offset">+/-</label>
      <input type="number" name="offset" id="offset"/>
      {% if tide_offset != 0 %}
      <span class="offset-num">{{ "+" if tide_offset > 0 else ""}}{{ tide_offset }}min</span>
      {% endif %}
        <label for="fav">Fav</label>
        <input type="checkbox" id="fav" name="fav" {{ 'checked' if is_fav else '' }} />
        <input hidden type="checkbox" id="fav_state" name="fav_state" {{ 'checked' if is_fav else '' }} />
        <button type="submit"/>Submit</button>
    </div>
</form>

<details>
    <summary>Today's text report</summary>
    <br>
    <table>
        {% for t in text_report %}
        <tr>
            <td>{{ t.time.strftime('%H:%M')}}</td>
            <td>{{ t.text|safe}}</td>
        </tr>
        {% endfor %}
    </table>
</details>


<h3>WX</h3>

<p><a href="https://marine.weather.gov/MapClick.php?lat={{ current_station['lat'] }}&lon={{ current_station['lng'] }}">Marine Forecast</a></p>

<table>
    {% for f in forecast %}
    <tr>
        <td>{{ f.when}}</td>
        <td>{{ f.text}}</td>
    </tr>
    {% endfor %}
</table>

<h3>Observations</h3>

<table>
    <tr>
        <td>Station:</td>
        <td><a href="https://tidesandcurrents.noaa.gov/stationhome.html?id={{ met_station['id'] }}">{{ met_station['name'] }}</a></td>
    </tr>
        {% for m in met_data %}
    <tr>
        <td>{{ m['type'] }}:</td>
        <td>{{ m['value'] }}&deg;F</td>
    </tr>
        {% endfor %}
    <tr>
        <td>Updated at:</td>
        <td>{{ met_data[0]['time'] }}</td>
    </tr>
</table>

<h3>Station Details</h3>

{% set tc = tide_station['lng']|string + "," + tide_station['lat']|string %}
{% set cc = current_station['lng']|string + "," + current_station['lat']|string %}
{% set at = "pk.eyJ1Ijoibmlja3d5bmphIiwiYSI6ImNtMzh6ZWN0YzBrbXUybG9nYXhjdnFlc2cifQ.uUURdxJOZ72zXmM9oqvW7g" %}

<img id="map" src="https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/static/pin-s+1e00ff({{tc}}),pin-s+ff0000({{cc}})/auto/600x400?padding=50&access_token={{at}}" />

<table>
    <tr>
        <td style="color: blue;">Tide:</td>
        <td><a href="https://tidesandcurrents.noaa.gov/stationhome.html?id={{ tide_station['id'] }}"</a>{{ tide_station['name'] }}</td>
    </tr>
    <tr>
        <td></td>
        <td><a href="https://tidesandcurrents.noaa.gov/map/index.html?lat={{ tide_station['lat'] }}&lng={{ tide_station['lng'] }}&zoom=11&type=tidepredictions&id={{ tide_station['id'] }}">View on map</td>
    </tr>
    <tr>
        <td></td>
        <td>{{ tide_station['lat'] }}, {{ tide_station['lng'] }}</td>
    </tr>
    <tr>
        <td style="color: red;">Current:</td>
        <td><a href="https://tidesandcurrents.noaa.gov/noaacurrents/predictions.html?id={{ current_station['id'] }}_1"</a>{{ current_station['name'] }}</td>
    </tr>
    <tr>
        <td></td>
        <td>{{ current_station['lat'] }}, {{ current_station['lng'] }}</td>
    </tr>
    <tr>
        <td></td>
        <td><a href="https://tidesandcurrents.noaa.gov/map/index.html?lat={{ current_station['lat'] }}&lng={{ current_station['lng'] }}&zoom=11&type=currentpredictions&id={{ current_station['id'] }}">View on map</td>
    </tr>
</table>

</body>
</html>
